<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Install Openstack from source code - keystone (mitaka) | 項 思 偉 ~ Aal Izz Well!</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <header>

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://siweixiang.github.io//xin">項 思 偉 ~ aal izz well!</a>
      </li>
      
      
      <li class="pull-right ">
        <a href="/">~/筆記</a>
      </li>
      
      
      <li class="pull-right ">
        <a href="/categories/">~/分類</a>
      </li>
      
      
      <li class="pull-right ">
        <a href="/tags/">~/標籤</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Install Openstack from source code - keystone (mitaka)</span></h1>

<h2 class="date">2017/03/04</h2>
<p class="terms">
  
  
  Categories: <a href="/categories/openstack">openstack</a> 
  
  
  
  Tags: <a href="/tags/linux">linux</a> <a href="/tags/centos">centos</a> <a href="/tags/openstack">openstack</a> 
  
  
</p>
</div>



<main>


<h2 id="install-keystone-dependences">Install keystone dependences</h2>

<pre><code class="language-bash">yum install $(cat openstack-keystone-deps.log | cut -d, -f1 | tr -s '\n'  ' ')
</code></pre>

<h2 id="git-clone-source-code-from-github">Git clone source code from github</h2>

<pre><code class="language-bash">git clone https://github.com/openstack/keystone

cd /src/openstack/keystone

git checkout stable/mitaka
</code></pre>

<h2 id="build-keystone-source-code">Build keystone source code</h2>

<pre><code class="language-bash">cd /src/openstack/keystone

python setup.py build
</code></pre>

<h2 id="make-keystone-configuration">Make keystone configuration</h2>

<pre><code class="language-bash">cp -aR etc/* /etc/keystone
mv /etc/keystone/keystone.conf.sample /etc/keystone/keystone.conf
mv /etc/keystone/logging.conf.sample /etc/keystone/logging.conf
mkdir /etc/keystone/fernet-keys/

sed -i -E -e '/^#.+?$/d' -e '/^$/d' /etc/keystone/keystone.conf
ini-config --set /etc/keystone/keystone.conf DEFAULT admin_token admintoken
ini-config --set /etc/keystone/keystone.conf database connection 'postgresql://keystone:openstack@controller/keystone'
ini-config --set /etc/keystone/keystone.conf token provider fernet
</code></pre>

<h2 id="create-keystone-all-and-keystone-manage-command">Create <em>keystone-all</em> and <em>keystone-manage</em> command</h2>

<pre><code class="language-bash">cat &gt; keystone/cmd/keystone-all &lt;&lt;EOF
#!/bin/python
import sys
from keystone.cmd.all import main
if __name__ == &quot;__main__&quot;:
    sys.exit(main())
EOF

cat &gt; keystone/cmd/keystone-manage &lt;&lt;EOF
#!/bin/python
import sys
from keystone.cmd.manage import main
if __name__ == &quot;__main__&quot;:
    sys.exit(main())
EOF
</code></pre>

<h2 id="populate-the-identity-service-database">Populate the Identity service database</h2>

<pre><code class="language-bash">python keystone/cmd/keystone-manage db_sync
</code></pre>

<h2 id="initialize-fernet-key-repositories">Initialize Fernet key repositories</h2>

<pre><code class="language-bash">python keystone/cmd/keystone-manage fernet_setup --keystone-user root --keystone-group root
</code></pre>

<h2 id="bootstrap-the-identity-service">Bootstrap the Identity service</h2>

<pre><code class="language-bash">python keystone/cmd/keystone-all --config-file=/etc/keystone/keystone.conf
</code></pre>

<h2 id="create-a-domain-projects-users-and-roles">Create a domain, projects, users, and roles</h2>

<pre><code class="language-bash">export OS_TOKEN=admintoken
export OS_URL=http://controller:35357/v3
export OS_IDENTITY_API_VERSION=3

openstack service create --name keystone --description &quot;OpenStack Identity&quot; identity
openstack endpoint create --region RegionOne identity public http://controller:5000/v3
openstack endpoint create --region RegionOne identity internal http://controller:5000/v3
openstack endpoint create --region RegionOne identity admin http://controller:35357/v3

openstack domain create --description &quot;Default Domain&quot; default
openstack project create --domain default --description &quot;Admin Project&quot; admin
openstack user create --domain default --password openstack admin
openstack role create admin
openstack role add --project admin --user admin admin
openstack project create --domain default --description &quot;Service Project&quot; service

cat &gt; ~/admin_rc &lt;&lt;EOF
export OS_PROJECT_DOMAIN_NAME=default
export OS_USER_DOMAIN_NAME=default
export OS_PROJECT_NAME=admin
export OS_USERNAME=admin
export OS_PASSWORD=openstack
export OS_AUTH_URL=http://controller:35357/v3
export OS_IDENTITY_API_VERSION=3
export OS_IMAGE_API_VERSION=2
export PS1='[\u@\h \W(admin)]\$ '
EOF
</code></pre>

</main>

    <footer>
      
<script async src="//yihui.name/js/center-img.js"></script>

      
      <hr/>
      &copy; [項思偉] 2017 | <a href="https://github.com/siweixiang">Github</a>
      
    </footer>
  </body>
</html>

