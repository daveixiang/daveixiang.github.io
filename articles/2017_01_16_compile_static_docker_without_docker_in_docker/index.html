<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <title>Compile static docker without docker in docker | 項 思 偉 ~ Aal Izz Well!</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    
  </head>

  <body>
    <nav>
    <ul class="menu">
      
      <li><a href="/xin">Home</a></li>
      
      <li><a href="/">Articles</a></li>
      
      <li><a href="/categories/">Categories</a></li>
      
      <li><a href="/tags/">Tags</a></li>
      
    </ul>
    <hr/>
    </nav>

<div class="article-meta">
<h1><span class="title">Compile static docker without docker in docker</span></h1>
</div>

<main>


<h1 id="install-dependencies">Install dependencies</h1>

<ul>
<li>Install xfs btrfs packages</li>
</ul>

<pre><code class="language-bash">emerge --ask sys-fs/btrfs-progs sys-fs/xfsprogs
</code></pre>

<ul>
<li>Install device mapper</li>
</ul>

<pre><code class="language-bash">export LVM2_VERSION=2.02.103 
mkdir -p /usr/local/src/lvm2 &amp;&amp;
curl -fsSL &quot;https://mirrors.kernel.org/sourceware/lvm2/LVM2.${LVM2_VERSION}.tgz&quot; | tar -xzC /usr/local/src/lvm2 --strip-components=1

cd /usr/local/src/lvm2 \
        &amp;&amp; ./configure \
                --build=&quot;$(gcc -print-multiarch)&quot; \
                --enable-static_link \
        &amp;&amp; make device-mapper \
        &amp;&amp; make install_device-mapper
</code></pre>

<h1 id="compile-runc-binary">Compile runc binary</h1>

<ul>
<li>get the runc source code</li>
</ul>

<pre><code class="language-bash">mkdir -p /go/src/github.com/opencontainers/

cd /go/src/github.com/opencontainers/

git clone https://github.com/opencontainers/runc.git
</code></pre>

<ul>
<li>Compile static runc binary</li>
</ul>

<pre><code class="language-bash">cd runc

git checkout v1.0.0-rc2

make static
</code></pre>

<ul>
<li>Install runc</li>
</ul>

<pre><code class="language-bash">mkdir -p /go/bin

cp runc /go/bin/docker-runc
</code></pre>

<h1 id="compile-containerd-binary">Compile containerd binary</h1>

<ul>
<li>get the containerd source code</li>
</ul>

<pre><code class="language-bash">mkdir -p /go/src/github.com/docker/

cd /go/src/github.com/docker/

git clone https://github.com/docker/containerd.git
</code></pre>

<ul>
<li>Compile static containerd binary</li>
</ul>

<pre><code class="language-bash">cd containerd

git checkout v0.2.5

export GOPATH=/go

make static
</code></pre>

<ul>
<li>Install containerd</li>
</ul>

<pre><code class="language-bash">cp bin/containerd /go/bin/docker-containerd

cp bin/containerd-shim /go/bin/docker-containerd-shim

cp bin/ctr /go/bin/docker-ctr
</code></pre>

<h1 id="compile-docker-binary">Compile docker binary</h1>

<ul>
<li>Get the docker source code</li>
</ul>

<pre><code class="language-bash">cd /go/src/github.com/docker/

git clone https://github.com/docker/docker.git
</code></pre>

<ul>
<li>Compile static docker binary</li>
</ul>

<pre><code class="language-bash">cd docker

git checkout v1.12.6

export GOPATH=/go
export AUTO_GOPATH=1

hack/make.sh binary
</code></pre>

<ul>
<li>Install docker binary</li>
</ul>

<pre><code class="language-bash">cp bundles/latest/binary-client/docker /go/bin/docker

cp bundles/latest/binary-daemon/dockerd /go/bin/dockerd

cp bundles/latest/binary-daemon/docker-proxy /go/bin/docker-proxy
</code></pre>

<h1 id="check-the-build-result">Check the build result</h1>

<ul>
<li>Start docker daemon</li>
</ul>

<pre><code class="language-bash">dockerd --log-level=error
</code></pre>

<p>and the output is:</p>

<pre><code class="language-txt">WARN[0000] containerd: low RLIMIT_NOFILE changing to max  current=1024 max=4096
ERRO[0001] devmapper: Udev sync is not supported. This will lead to data loss and unexpected behavior. Install a dynamic binary to use devicemapper or select a different storage driver. For more information, see https://docs.docker.com/engine/reference/commandline/daemon/#daemon-storage-driver-option
</code></pre>

<ul>
<li>Checkout docker info</li>
</ul>

<pre><code class="language-bash">docker info
</code></pre>

<p>the client and daemon info:</p>

<pre><code class="language-txt">Containers: 0
 Running: 0
 Paused: 0
 Stopped: 0
Images: 0
Server Version: 1.12.6
Storage Driver: overlay
 Backing Filesystem: xfs
Logging Driver: json-file
Cgroup Driver: cgroupfs
Plugins:
 Volume: local
 Network: host bridge null overlay
Swarm: inactive
Runtimes: runc
Default Runtime: runc
Security Options: apparmor
Kernel Version: 4.4.39-gentoo
Operating System: Gentoo/Linux
OSType: linux
Architecture: x86_64
CPUs: 4
Total Memory: 7.796 GiB
Name: meta
ID: ZZOZ:GWOT:4LCM:5P7V:F2JW:2S3F:LTLM:H5N4:TX5W:DOR3:BVM6:XYZO
Docker Root Dir: /var/lib/docker
Debug Mode (client): false
Debug Mode (server): false
Registry: https://index.docker.io/v1/
WARNING: No swap limit support
Insecure Registries:
 127.0.0.0/8
</code></pre>

<ul>
<li>pull <em>hello-world</em> image</li>
</ul>

<pre><code class="language-bash">docker pull hello-world
</code></pre>

<p>and the output is:</p>

<pre><code class="language-txt">Using default tag: latest
latest: Pulling from library/hello-world
c04b14da8d14: Pull complete 
Digest: sha256:0256e8a36e2070f7bf2d0b0763dbabdd67798512411de4cdcf9431a1feb60fd9
Status: Downloaded newer image for hello-world:latest
</code></pre>

<ul>
<li>run <em>hello-world</em> container</li>
</ul>

<pre><code class="language-bash">docker run hello-world
</code></pre>

<p>the output is:</p>

<pre><code class="language-txt">Hello from Docker!
This message shows that your installation appears to be working correctly.

To generate this message, Docker took the following steps:
 1. The Docker client contacted the Docker daemon.
 2. The Docker daemon pulled the &quot;hello-world&quot; image from the Docker Hub.
 3. The Docker daemon created a new container from that image which runs the
    executable that produces the output you are currently reading.
 4. The Docker daemon streamed that output to the Docker client, which sent it
    to your terminal.

To try something more ambitious, you can run an Ubuntu container with:
 $ docker run -it ubuntu bash

Share images, automate workflows, and more with a free Docker Hub account:
 https://hub.docker.com

For more examples and ideas, visit:
 https://docs.docker.com/engine/userguide/
</code></pre>

</main>

  <footer>
  
  
  <hr/>
  &copy; [項思偉] 2017 | <a href="https://github.com/daveixiang">Github</a>
  
  </footer>
  </body>
</html>

