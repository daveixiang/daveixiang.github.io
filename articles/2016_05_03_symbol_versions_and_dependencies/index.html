<!DOCTYPE html>
<html lang="en-us">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <title>Symbol versions and dependencies | 項 思 偉 ~ Aal Izz Well!</title>
    <link rel="stylesheet" href="/css/style.css" />
    <link rel="stylesheet" href="/css/fonts.css" />
    <header>

  
  <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/styles/atom-one-light.min.css">
  <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.12.0/highlight.min.js"></script>
  <script>hljs.initHighlightingOnLoad();</script>
  <nav>
    <ul>
      
      
      <li class="pull-left ">
        <a href="https://siweixiang.github.io//xin">項 思 偉 ~ aal izz well!</a>
      </li>
      
      
      <li class="pull-right ">
        <a href="/">~/筆記</a>
      </li>
      
      
      <li class="pull-right ">
        <a href="/categories/">~/分類</a>
      </li>
      
      
      <li class="pull-right ">
        <a href="/tags/">~/標籤</a>
      </li>
      

    </ul>
  </nav>
</header>

  </head>

  <body>
    <br/>

<div class="article-meta">
<h1><span class="title">Symbol versions and dependencies</span></h1>

<h2 class="date">2016/05/03</h2>
<p class="terms">
  
  
  Categories: <a href="/categories/clan">clan</a> 
  
  
  
  Tags: <a href="/tags/clan">clan</a> 
  
  
</p>
</div>



<main>
<p>The documentation on ld&rsquo;s symbol versioning syntax is a little bit
vague on &ldquo;dependencies&rdquo;, which it talks about but doesn&rsquo;t give many
details on.</p>

<p>Let&rsquo;s construct a small example.</p>

<ul>
<li>foo.c</li>
</ul>

<pre><code class="language-c">#include &lt;stdio.h&gt;

#ifndef VERSION_2
void foo(int f) {
     printf(&quot;version 1 called\n&quot;);
}

#else
void foo_v1(int f) {
     printf(&quot;version 1 called\n&quot;);
}
__asm__(&quot;.symver foo_v1,foo@VERSION_1&quot;);

void foo_v2(int f) {
     printf(&quot;version 2 called\n&quot;);
}
/* i.e. foo_v2 is really foo@VERSION_2
 * @@ means this is the default version
 */
__asm__(&quot;.symver foo_v2,foo@@VERSION_2&quot;);

#endif
</code></pre>

<ul>
<li>1.ver</li>
</ul>

<pre><code class="language-txt">VERSION_1 {
      global:
      foo;
      local:
      *;
};
</code></pre>

<ul>
<li>2.ver</li>
</ul>

<pre><code class="language-txt">VERSION_1 {
      local:
      *;
};

VERSION_2 {
      foo;
} VERSION_1;
</code></pre>

<ul>
<li>main.c</li>
</ul>

<pre><code class="language-c">#include &lt;stdio.h&gt;

void foo(int);

int main(void) {
    foo(100);
    return 0;
}
</code></pre>

<ul>
<li>Makefile</li>
</ul>

<pre><code class="language-makefile">all: v1 v2

libfoo.so.1 : foo.c
	gcc -shared -fPIC -o libfoo.so.1 -Wl,--soname='libfoo.so.1' -Wl,--version-script=1.ver foo.c

libfoo.so.2 : foo.c
	gcc -shared -fPIC -DVERSION_2 -o libfoo.so.2 -Wl,--soname='libfoo.so.2' -Wl,--version-script=2.ver foo.c

v1: main.c libfoo.so.1
    ln -sf libfoo.so.1 libfoo.so
    gcc -Wall -o v1 -lfoo -L. -Wl,-rpath=. main.c

v2: main.c libfoo.so.2
    ln -sf libfoo.so.2 libfoo.so
    gcc -Wall -o v2 -lfoo -L. -Wl,-rpath=. main.c

.PHONY: clean
clean:
    rm -f libfoo* v1 v2
</code></pre>

</main>

    <footer>
      
<script async src="//yihui.name/js/center-img.js"></script>

      
      <hr/>
      &copy; [項思偉] 2017 | <a href="https://github.com/siweixiang">Github</a>
      
    </footer>
  </body>
</html>

